// frameworks
var Hapi = require('hapi');
var mongoose = require('mongoose');
var BasicStrategy = require('passport-http').BasicStrategy;

// mongoose models
var Check = require('./lib/models/Check');
var User = require('./lib/models/User');

// plugins config
var plugins = {
    furball: { },
    yar: {
        cookieOptions: {
            password: "secret",
            isSecure: false
        }
    },
    travelogue: {
        hostname: 'localhost',
        port: 8000
    },
    good: {
        subscribers: {
            'console': ['ops', 'request', 'log', 'error'],
            './tmp/logs/': ['request', 'log']
        }
    },
    bassmaster: { }
}

// routes config
var status = {
    auth: false,
    handler: function (request, reply) {
        reply({ status: 'ok' });
    }
}

var writeCheck = {
    auth: false,
    handler: function (request, reply) {
        Passport.authenticate('basic', {session: false })(request, reply, function() {
            var check = new Check({
                checkNumber: request.payload.number,
                checkDate: request.payload.date,
                checkAmount: request.payload.amount,
                checkPayee: request.payload.payee,
                checkMemo: request.payload.memo
            });
            check.save(function (err, objToSave) {
                if (err) { 
                    console.log("error: " + err);
                    return reply.error(err);
                }
            });
            reply().created('/checks/' + check._id);
        });
    }
}


var findCheck = {
    auth: false,
    cache: { expiresIn: 5000 },
    handler: function (request, reply) {
        Passport.authenticate('basic', {session: false })(request, reply, function() {
            Check.findOne({ checkNumber: request.params.number })
                .select('checkNumber checkDate checkPayee checkAmount checkMemo checkReconciled')
                .exec(function (err, check) {
                    if (err) {
                        console.log("error: " + err); 
                        return reply.error(err);
                    }
                    reply(check);
                });
        });
    }
}

var findAllChecks = {
    auth: false,
    cache: { expiresIn: 6000 },
    handler: function (request, reply) {
        Passport.authenticate('basic', { session: false })(request, reply, function () {
            Check.find()
                .select('checkNumber checkDate checkPayee checkAmount checkMemo checkReconciled')
                .exec(function (err, checks) {
                    if (err) {
                        console.log("error: ", err);
                        return reply.error(err);
                    }
                    reply(checks);
                });
        });
    }
}

var reconcileCheck = {
    auth: false,
    handler: function (request, reply) {
        Passport.authenticate('basic', { session: false })(request, reply, function () {
            Check.findOneAndUpdate({ checkNumber: request.params.number }, { reconciled: true, reconciledDate: Date.Now }, { select: 'reconciled recociledDate' }, function (res) {
                request.reply(res.result):
            });
        });
    }
}

var voidCheck = {
    auth: false,
    handler: function (request, reply) {
        Passport.authenticate('basic', { session: false })(request, reply, function () {
            Check.findOneAndRemove({ checkNumber: request.params.number }, function (res) {
                request.reply(res.result);
            });
        });
    }
}

var reconcile = {
    auth: false,
    handler: function (request, reply) {
        Passport.authenticate('basic', { session: false })(request, reply, function () {
            
            server.inject({
                method: 'POST',
                url: '/batch',
                payload: '{ "requests": [{ "method": "get", "path": "/status" }, { "method": "get", "path": "/checks" }, { "method": "get", "path": "/checks/$1.id" }] }'
            }, function (res) {
                
                request.reply(res.result);
            });
        });
    }
}

// Create a server with a port
var server = Hapi.createServer('localhost', 8000);

// install plugins
server.pack.require(plugins, function(err) {
    if (err) {
        console.log("error loading plugins: " + err);
        throw err;
    }
});

// auth config
server.auth.strategy('passport', 'passport');
var Passport = server.plugins.travelogue.passport;
Passport.use(new BasicStrategy(
    function(username, password, done) {
        User.findOne({ username: username }, function (err, user) {
            if (err) { return done(err); }
            if (!user) { return done(null, false); }
            if (!user.password === password) { return done(null, false); }
            return done(null, user);
        });
    }
));

// Add the routes
server.route([
    {
        method: 'GET',
        path: '/status',
        config: status
    }, {
        method: 'POST',
        path: '/checks',
        config: writeCheck                    
    }, {
        method: 'GET',
        path: '/checks/{number}',
        config: findCheck            
    }, {
        method: 'GET',
        path: '/checks',
        config: findAllChecks
    }, {
        method: 'GET',
        path: '/reconcile',
        config: reconcile
    }
]);

// Start the server
mongoose.connect('mongodb://localhost/checks');
server.start(function() {
    Passport.initialize();
    console.log('server started on port: ', server.info.port);
    console.log('using hapi plugins: ', server.plugins.furball.plugins(server));
});
